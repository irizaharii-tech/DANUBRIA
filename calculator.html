<script>
const coords = {
  // Spain
  madrid: [-3.7038, 40.4168],
  barcelona: [2.1734, 41.3851],
  valencia: [-0.3763, 39.4699],
  irun: [-1.7831, 43.339],
  zaragoza: [-0.8891, 41.6488],
  // France
  nice: [7.2620, 43.7102],
  lyon: [4.8357, 45.7640],
  paris: [2.3522, 48.8566],
  marseille: [5.3698, 43.2965],
  toulouse: [1.4442, 43.6047],
  // Italy
  milan: [9.19, 45.4642],
  turin: [7.6869, 45.0703],
  bologna: [11.3426, 44.4949],
  verona: [10.9916, 45.4384],
  venice: [12.3155, 45.4408],
  florence: [11.2558, 43.7699],
  rome: [12.4964, 41.9028],
  naples: [14.2681, 40.8518]
};

function getCountry(city) {
  const spain = ['madrid', 'barcelona', 'valencia', 'irun', 'zaragoza'];
  const france = ['nice', 'lyon', 'paris', 'marseille', 'toulouse'];
  const italy = ['milan', 'turin', 'bologna', 'verona', 'venice', 'florence', 'rome', 'naples'];
  if (spain.includes(city)) return 'es';
  if (france.includes(city)) return 'fr';
  if (italy.includes(city)) return 'it';
  return '';
}

// Fetch distance from OpenRouteService API
async function getDistanceORS(origin, destination) {
  const originCountry = getCountry(origin);
  const destCountry = getCountry(destination);
  let waypoints = [coords[origin], coords[destination]];

  // Force route via Nice for Spain↔Italy or Italy↔Spain
  if (
    (originCountry === 'es' && destCountry === 'it') ||
    (originCountry === 'it' && destCountry === 'es')
  ) {
    waypoints = [coords[origin], coords['nice'], coords[destination]];
  }

  const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImQ2Mjg4MTJjNjJhYzRjZTdhNmM5MGFlNTFjYTRkNjk2IiwiaCI6Im11cm11cjY0In0=";

  try {
    const response = await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": apiKey
      },
      body: JSON.stringify({ coordinates: waypoints })
    });

    if (!response.ok) {
      console.error("ORS API error:", response.statusText);
      return 1000; // fallback
    }

    const data = await response.json();
    const meters = data.features[0].properties.summary.distance;
    const km = meters / 1000;
    console.log(`Route ${origin} → ${destination}: ${km.toFixed(1)} km`);
    return km;
  } catch (error) {
    console.error("ORS request failed:", error);
    return 1000;
  }
}

// Rate setup
const rates = {
  'es-it-north': 1.15,
  'es-it-south': 1.25,
  'es-fr': 1.50,
  'fr-es': 1.15,
  'it-es': 1.80
};

function getRate(origin, destination) {
  const originCountry = getCountry(origin);
  const destCountry = getCountry(destination);

  if (originCountry === 'es') {
    if (destCountry === 'it') {
      const northItaly = ['milan', 'turin', 'bologna', 'venice', 'verona', 'florence'];
      return northItaly.includes(destination) ? rates['es-it-north'] : rates['es-it-south'];
    }
    if (destCountry === 'fr') return rates['es-fr'];
  }
  if (originCountry === 'fr' && destCountry === 'es') return rates['fr-es'];
  if (originCountry === 'it' && destCountry === 'es') return rates['it-es'];
  return 1.5;
}

document.addEventListener('DOMContentLoaded', () => {
  feather.replace();

  const calculateBtn = document.getElementById('calculate-btn');
  const quoteResult = document.getElementById('quote-result');
  const ftlResult = document.getElementById('ftl-result');
  const specialTransport = document.getElementById('special-transport');

  calculateBtn.addEventListener('click', async () => {
    const origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;
    const transportType = document.getElementById('transport-type').value;

    if (!origin || !destination) {
      alert('Please select both origin and destination');
      return;
    }

    quoteResult.classList.remove('hidden');

    if (transportType !== 'ftl') {
      ftlResult.classList.add('hidden');
      specialTransport.classList.remove('hidden');
      return;
    }

    ftlResult.classList.remove('hidden');
    specialTransport.classList.add('hidden');

    const distance = await getDistanceORS(origin, destination);
    const rate = getRate(origin, destination);
    const price = Math.round(distance * rate * 100) / 100;

    document.getElementById('price-estimate').textContent = `€${price.toLocaleString()}`;
    document.getElementById('distance-info').textContent = `Distance: ${distance.toFixed(1)} km`;
    document.getElementById('rate-info').textContent = `Rate: €${rate} per km`;

    anime({
      targets: '#quote-result',
      opacity: [0, 1],
      translateY: [10, 0],
      duration: 300,
      easing: 'easeOutQuad'
    });
  });
});
</script>
